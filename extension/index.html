<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Hello World Extension</title>
    <script src="https://extension-files.twitch.tv/helper/v1/twitch-ext.min.js"></script>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background-color: transparent; /* Transparent background */
        font-family: Arial, sans-serif;
        overflow: hidden; /* Prevent scrolling */
        position: relative;
      }

      #minimap-container {
        width: 25%;
        height: 25%;
        max-width: 300px;
        max-height: 300px;
        position: absolute;
        bottom: 0;
        left: 0;
        background-color: #0000008a; /* Black background */
        color: #fff;
        border: 2px solid #333;
        border-radius: 8px;
        padding: 10px;
        box-sizing: border-box;
        margin: 10px; /* Add some margin from the edge */
      }

      .bubble {
        position: absolute;
        border-radius: 50%;
        pointer-events: none; /* Make bubbles not interactive */
      }

      #settings-button, #reconnect-button {
        width: 33%;
        margin: 5px 0;
        padding: 10px;
        background-color: #333;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-align: center;
      }

      #settings-menu {
        display: none;
        position: absolute;
        top: 10%;
        left: 5%;
        padding: 10px;
        background-color: #444;
        color: #fff;
        border: 1px solid #222;
        border-radius: 4px;
        width: 90%;
        box-sizing: border-box;
      }

      #settings-menu label {
        display: block;
        margin-top: 10px;
      }

      #settings-menu input {
        margin-top: 5px;
        width: 50%;
      }

      @keyframes expand {
        from {
          transform: scale(0.1);
          opacity: 0.5;
        }
        to {
          transform: scale(2);
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <div id="minimap-container">
      <button id="settings-button">Settings</button>
      <button id="reconnect-button">Reconnect</button>
      <div id="settings-menu">
        <label>
          Bubble Color:
          <input type="color" id="bubble-color" value="#00ff00" />
        </label>
        <label>
          Bubble Size:
          <input type="number" id="bubble-size" value="50" min="10" max="200" />
        </label>
        <button id="save-settings">Save</button>
      </div>
    </div>
  </body>
  <script>
    const TestAuth = {
      channelId: "468106723",
      userId: "468106723",
    };
    const TESTING = window.location.hostname == "localhost";

    function runGameJam(auth) {
      let wsUrl =
        "wss://websocket.matissetec.dev/lobby/connect?user=" + auth.channelId;
      let socket;
      const userId = auth.userId;

      function connectWebSocket() {
        socket = new WebSocket(wsUrl);

        socket.addEventListener("open", function (event) {
          console.log("Connected to the WebSocket server");
          socket.send("Hello Server!");
        });

        socket.addEventListener("message", function (event) {
          console.log("Message from server:", event.data);
        });

        socket.addEventListener("close", function (event) {
          console.log("Disconnected from the WebSocket server");
        });

        socket.addEventListener("error", function (event) {
          console.error("WebSocket error:", event);
        });
      }

      connectWebSocket();

      let animationDuration = 3; // Default duration in seconds
      let bubbleColor = "#00ff00";
      let bubbleSize = 50;

      function sendMessage(message) {
        if (socket.readyState === WebSocket.OPEN) {
          socket.send(message);
        } else {
          console.error(
            "WebSocket is not open. Ready state:",
            socket.readyState,
          );
        }
      }

      window.Twitch.ext.onContext(function (context) {
        animationDuration = Math.max(
          1,
          Math.min(10, context.hlsLatencyBroadcaster),
        );
      });

      document
        .getElementById("settings-button")
        .addEventListener("click", function () {
          const settingsMenu = document.getElementById("settings-menu");
          settingsMenu.style.display =
            settingsMenu.style.display === "none" ? "block" : "none";
        });

      document
        .getElementById("save-settings")
        .addEventListener("click", function () {
          bubbleColor = document.getElementById("bubble-color").value;
          bubbleSize = parseInt(
            document.getElementById("bubble-size").value,
            10,
          );
          document.getElementById("settings-menu").style.display = "none";
          const data = {
            bubbleColor: bubbleColor,
            bubbleSize: bubbleSize,
            userId: userId,
          };
          sendMessage(JSON.stringify(data));
        });

      document
        .getElementById("reconnect-button")
        .addEventListener("click", function () {
          connectWebSocket();
        });

      document.getElementById("minimap-container").addEventListener("click", function (event) {
        const minimap = document.getElementById("minimap-container");
        const rect = minimap.getBoundingClientRect();
        const x = (event.clientX - rect.left) / rect.width;
        const y = (event.clientY - rect.top) / rect.height;

        const data = {
          x: x,
          y: y,
          userId: userId,
        };
        sendMessage(JSON.stringify(data));

        const bubble = document.createElement("div");
        bubble.classList.add("bubble");
        bubble.style.width = `${bubbleSize}px`;
        bubble.style.height = `${bubbleSize}px`;
        bubble.style.left = `${event.clientX - rect.left - bubbleSize / 2}px`;
        bubble.style.top = `${event.clientY - rect.top - bubbleSize / 2}px`;
        bubble.style.background = `radial-gradient(circle, ${bubbleColor}80, ${bubbleColor}40)`;
        bubble.style.animation = `expand ${animationDuration}s forwards`;
        minimap.appendChild(bubble);
        bubble.addEventListener("animationend", () => {
          bubble.remove();
        });
      });
    }

    if (TESTING) {
      runGameJam(TestAuth);
    } else {
      window.Twitch.ext.onAuthorized(runGameJam);
    }
  </script>
</html>
