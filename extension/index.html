<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Hello World Extension</title>
    <script src="https://extension-files.twitch.tv/helper/v1/twitch-ext.min.js"></script>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background-color: transparent; /* Transparent background */
        font-family: Arial, sans-serif;
        overflow: hidden; /* Prevent scrolling */
        position: relative;
      }

      #minimap-container {
        width: 300px;
        height: 300px;
        position: absolute;
        bottom: 0;
        left: 0;
        background-color: #0000008a; /* Black background */
        color: #fff;
        border: 2px solid #333;
        border-radius: 8px;
        box-sizing: border-box;
        margin: 10px; /* Add some margin from the edge */
        overflow: hidden;
      }

      .bubble {
        position: absolute;
        border-radius: 50%;
        pointer-events: none; /* Make bubbles not interactive */
      }

      #settings-button, #reconnect-button {
        width: 33%;
        margin: 5px 0;
        padding: 10px;
        background-color: #333;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-align: center;
      }

      #settings-menu {
        display: none;
        position: absolute;
        top: 10%;
        left: 5%;
        padding: 10px;
        background-color: #444;
        color: #fff;
        border: 1px solid #222;
        border-radius: 4px;
        width: 90%;
        box-sizing: border-box;
      }

      #settings-menu label {
        display: block;
        margin-top: 10px;
      }

      #settings-menu input {
        margin-top: 5px;
        width: 50%;
      }

      @keyframes expand {
        from {
          scale: 0.1;
          opacity: 0.5;
        }
        to {
          scale: 2;
          opacity: 0;
        }
      }

      #units-container, #background, #background-animation {
          width: 100%;
          height: 100%;

      }
      #background {
          background-image: repeating-radial-gradient(circle at var(--x) var(--y), gray, gray 2px, transparent 2px, transparent 10px),
                            repeating-conic-gradient(at var(--x) var(--y), gray, gray 2deg, transparent 2deg, transparent 20deg);
      }
      #background-animation {
          scale: 1.5;

          background-image: conic-gradient(transparent, rgb(130, 200, 130) 5deg, transparent 90deg);
          animation: scan 8s linear infinite;
      }
      @keyframes scan {
          from {
              rotate: 360deg;
          }
          to {
              rotate: 0deg;
          }
      }
      .unit {
          --size: 15px;

          position: absolute;

          width: var(--size);
          height: var(--size);

          left: var(--x);
          top: var(--y);
          transform: translate(-50%, -50%);

          opacity: 0.8;
          border: white solid 0.5px;
      }

      .Sphere {
          background-color: rgb(186, 125, 12);
          border-radius: var(--size);
      }
      .Cube {
          background-color: rgb(101, 122, 9);
      }
      .Player {
          --size: 40px;
          opacity: 0.3;
          background-color: blue;
          border-radius: var(--size);
      }
      .Suzanne {
          background-color: rgb(21, 142, 0);
      }
      .Bozz {
            background-color: rgb(255, 0, 0);
      }

      .unit_enter_bubble {
          position: absolute;

          --size: 100px;
          width: var(--size);
          height: var(--size);
          border-radius: var(--size);

          left: 50%;
          top: 50%;
          translate: -50% -50%;

          background-color: rgb(170, 220, 170);
          animation: expand 2s linear;
      }
    </style>
  </head>
  <body>
      <button id="settings-button">Settings</button>
      <button id="reconnect-button">Reconnect</button>
      <div id="settings-menu">
        <label>
          Bubble Color:
          <input type="color" id="bubble-color" value="#00ff00" />
        </label>
        <label>
          Bubble Size:
          <input type="number" id="bubble-size" value="50" min="10" max="200" />
        </label>
        <button id="save-settings">Save</button>
      </div>
    <div id="minimap-container">
      <div id="units-container">
          <div id="background">
              <!-- <div id="background-animation"> -->
              <!-- </div> -->
          </div>
      </div>
    </div>
  </body>
  <script>
    const TestAuth = {
      channelId: "468106723",
      userId: "468106723",
    };
    const TESTING = window.location.hostname == "localhost";

    function updateMinimap(data) {
        console.log("Updating minimap");
        let container = document.getElementById("units-container");
        for (const unit of data) {
            let node = document.getElementById(unit.id);
            if (node === null) {
                console.log("creating new node for", unit.id);

                node = document.createElement("div");
                container.appendChild(node);

                node.id = unit.id;
                node.classList.add("unit");
                node.classList.add(unit.kind);
                
                let bubble = document.createElement("div");
                bubble.classList.add("unit_enter_bubble");
                node.appendChild(bubble); 

                bubble.addEventListener("animationend", () => {
                  bubble.remove();
                });
            }

            let x = `${unit.x * 100}%`;
            let y = `${unit.y * 100}%`;

            node.style.setProperty("--x", x);
            node.style.setProperty("--y", y);

            if (unit.kind === "Player") {
                let background = document.getElementById("background");
                background.style.setProperty("--x", x);
                background.style.setProperty("--y", y);
            }
        }
    }

    function resetMinimap() {
        let units = Array.from(document.getElementsByClassName("unit"));
        for (const unit of units) {
            unit.remove();
        }
    }

    function runGameJam(auth) {
      let wsUrl =
        "wss://websocket.matissetec.dev/lobby/connect?user=" + auth.channelId;
      let socket;
      const userId = auth.userId;

      function connectWebSocket() {
        socket = new WebSocket(wsUrl);

        socket.addEventListener("open", function (event) {
          console.log("Connected to the WebSocket server");
          let container = document.getElementById("minimap-container");
          container.style.display = "inital";
          socket.send("Hello Server!");
        });

        socket.addEventListener("message", function (event) {
          <!-- console.log("Message from server:", event.data); -->
          let data = JSON.parse(event.data);
          if (data.data.hasOwnProperty("reset")) {
            console.log("Resetting minimap");
            resetMinimap();
          }
          updateMinimap(data.data);
        });

        socket.addEventListener("close", function (event) {
          console.log("Disconnected from the WebSocket server");
        });

        socket.addEventListener("error", function (event) {
          let container = document.getElementById("minimap-container");
          container.style.display = "none";
          console.error("WebSocket error:", event);
        });
      }

      connectWebSocket();

      let animationDuration = 3; // Default duration in seconds
      let bubbleColor = "#00ff00";
      let bubbleSize = 50;

      function sendMessage(message) {
        if (socket.readyState === WebSocket.OPEN) {
          socket.send(message);
        } else {
          console.error(
            "WebSocket is not open. Ready state:",
            socket.readyState,
          );
        }
      }

      window.Twitch.ext.onContext(function (context) {
        animationDuration = Math.max(
          1,
          Math.min(10, context.hlsLatencyBroadcaster),
        );
      });

      document
        .getElementById("settings-button")
        .addEventListener("click", function () {
          const settingsMenu = document.getElementById("settings-menu");
          settingsMenu.style.display =
            settingsMenu.style.display === "none" ? "block" : "none";
        });

      document
        .getElementById("save-settings")
        .addEventListener("click", function () {
          bubbleColor = document.getElementById("bubble-color").value;
          bubbleSize = parseInt(
            document.getElementById("bubble-size").value,
            10,
          );
          document.getElementById("settings-menu").style.display = "none";
          const data = {
            bubbleColor: bubbleColor,
            bubbleSize: bubbleSize,
            userId: userId,
          };
          sendMessage(JSON.stringify(data));
        });

      document
        .getElementById("reconnect-button")
        .addEventListener("click", function () {
          connectWebSocket();
        });

      document.getElementById("minimap-container").addEventListener("click", function (event) {
        const minimap = document.getElementById("minimap-container");
        const rect = minimap.getBoundingClientRect();
        const x = (event.clientX - rect.left) / rect.width;
        const y = (event.clientY - rect.top) / rect.height;

        const data = {
          x: x,
          y: y,
          userId: userId,
          bubbleColor: bubbleColor,
          bubbleSize: bubbleSize
        };
        sendMessage(JSON.stringify(data));

        const bubble = document.createElement("div");
        bubble.classList.add("bubble");
        bubble.style.width = `${bubbleSize}px`;
        bubble.style.height = `${bubbleSize}px`;
        bubble.style.left = `${event.clientX - rect.left - bubbleSize / 2}px`;
        bubble.style.top = `${event.clientY - rect.top - bubbleSize / 2}px`;
        bubble.style.background = `radial-gradient(circle, ${bubbleColor}80, ${bubbleColor}40)`;
        bubble.style.animation = `expand ${animationDuration}s forwards`;
        minimap.appendChild(bubble);
        bubble.addEventListener("animationend", () => {
          bubble.remove();
        });
      });
    }

    if (TESTING) {
      runGameJam(TestAuth);
    } else {
      window.Twitch.ext.onAuthorized(runGameJam);
    }
  </script>
</html>
